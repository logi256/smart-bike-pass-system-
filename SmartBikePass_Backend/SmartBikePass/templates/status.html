{% extends "base.html" %}
{% block title %}Check Application Status{% endblock %}
{% block content %}
<div class="container">
  <div class="card">
    <h2>ğŸ” Check Application Status</h2>
    <p style="color:#64748b;margin-bottom:22px">Enter your Pass ID received after submission to check the current status.</p>
    <div style="display:flex;gap:12px">
      <input type="text" id="pass-input" placeholder="Enter Pass ID (e.g. SBPS-XXXXXXXX)" style="margin:0;flex:1">
      <button class="btn btn-primary" onclick="checkStatus()">Check</button>
    </div>
    <div id="result" style="margin-top:24px"></div>
  </div>
</div>

<script>
async function checkStatus() {
  const pid = document.getElementById('pass-input').value.trim().toUpperCase();
  if (!pid) { alert('Please enter a Pass ID'); return; }

  document.getElementById('result').innerHTML = '<div class="spinner">â³ Fetching status...</div>';
  try {
    const res = await fetch(`/api/status/${pid}`);
    const data = await res.json();
    if (!data.success) {
      document.getElementById('result').innerHTML = `<div class="alert alert-error">âŒ ${data.error}</div>`;
      return;
    }
    const d = data.data;
    const statusLabel = {
      pending: 'â³ Pending - Awaiting Transport Review',
      transport_verified: 'ğŸ”µ Transport Verified - Awaiting Principal Approval',
      transport_rejected: 'âŒ Rejected by Transport In-Charge',
      approved: 'âœ… Approved - Pass Issued',
      principal_rejected: 'âŒ Rejected by Principal'
    };
    const approvedLink = d.status === 'approved' ? `<a href="/approved/${d.pass_id}" class="btn btn-success" style="margin-top:14px;display:inline-block">ğŸ“± View Digital Pass</a>` : '';
    document.getElementById('result').innerHTML = `
      <div class="card" style="background:#f8fafc;border:1.5px solid #e2e8f0">
        <h3>Application Details</h3>
        <table style="margin-top:10px">
          <tr><th>Pass ID</th><td>${d.pass_id}</td></tr>
          <tr><th>Name</th><td>${d.full_name}</td></tr>
          <tr><th>Vehicle No</th><td>${d.vehicle_no}</td></tr>
          <tr><th>Submitted</th><td>${d.submitted_at}</td></tr>
          <tr><th>Current Status</th><td><span class="badge badge-${d.status}">${statusLabel[d.status] || d.status}</span></td></tr>
          ${d.transport_remarks ? `<tr><th>Transport Remarks</th><td>${d.transport_remarks}</td></tr>` : ''}
          ${d.principal_remarks ? `<tr><th>Principal Remarks</th><td>${d.principal_remarks}</td></tr>` : ''}
        </table>
        ${approvedLink}
      </div>`;
  } catch(e) {
    document.getElementById('result').innerHTML = '<div class="alert alert-error">âŒ Network error. Please try again.</div>';
  }
}
document.getElementById('pass-input').addEventListener('keydown', e => { if(e.key==='Enter') checkStatus(); });
</script>
{% endblock %}
